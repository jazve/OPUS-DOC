# å•å…ƒæµ‹è¯•æŒ‡å—

## ğŸ¯ å•å…ƒæµ‹è¯•æ¦‚è¿°

å•å…ƒæµ‹è¯•æ˜¯å¯¹OPUSç³»ç»Ÿä¸­æœ€å°å¯æµ‹è¯•å•å…ƒçš„éªŒè¯ï¼Œç¡®ä¿æ¯ä¸ªç»„ä»¶åœ¨éš”ç¦»ç¯å¢ƒä¸‹çš„æ­£ç¡®æ€§ã€‚

## ğŸ“‹ æµ‹è¯•èŒƒå›´

### æ ¸å¿ƒç»„ä»¶æµ‹è¯•
- **Identityæ¨¡å—** - èº«ä»½å®šä¹‰å’ŒéªŒè¯
- **Architectureæ¨¡å—** - æ¶æ„é…ç½®è§£æ
- **Memoryæ¨¡å—** - è®°å¿†ç®¡ç†åŠŸèƒ½
- **Formatsæ¨¡å—** - æ ¼å¼åŒ–è¾“å‡º
- **Workflowæ¨¡å—** - å·¥ä½œæµæ‰§è¡Œ
- **Constraintsæ¨¡å—** - çº¦æŸéªŒè¯

### è¯­æ³•è§£ææµ‹è¯•
- **OPUSè¯­æ³•è§£æå™¨** - è¯­æ³•è§„åˆ™éªŒè¯
- **æ¨¡å—è¯­æ³•è§£æ** - æ¨¡å—å®šä¹‰è§£æ
- **å‡½æ•°è¯­æ³•è§£æ** - å‡½æ•°è°ƒç”¨è§£æ
- **å˜é‡å¼•ç”¨è§£æ** - å˜é‡æ“ä½œè§£æ

### å·¥å…·å‡½æ•°æµ‹è¯•
- **å­—ç¬¦ä¸²å¤„ç†** - æ–‡æœ¬å¤„ç†å·¥å…·
- **æ•°æ®éªŒè¯** - è¾“å…¥éªŒè¯å‡½æ•°
- **æ ¼å¼è½¬æ¢** - æ•°æ®æ ¼å¼è½¬æ¢
- **é”™è¯¯å¤„ç†** - å¼‚å¸¸å¤„ç†æœºåˆ¶

## ğŸ› ï¸ æµ‹è¯•æ¡†æ¶é…ç½®

### Pythonæµ‹è¯•ç¯å¢ƒ
```python
# requirements-test.txt
pytest>=7.0.0
pytest-cov>=4.0.0
pytest-mock>=3.0.0
pytest-asyncio>=0.21.0
faker>=15.0.0
factory-boy>=3.2.0
```

### æµ‹è¯•é…ç½®æ–‡ä»¶
```ini
# pytest.ini
[tool:pytest]
testpaths = tests/unit
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = 
    --cov=opus
    --cov-report=html
    --cov-report=term-missing
    --cov-fail-under=85
    -v
```

### ç›®å½•ç»“æ„
```
tests/unit/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ test_identity.py
â”‚   â”œâ”€â”€ test_architecture.py
â”‚   â”œâ”€â”€ test_memory.py
â”‚   â”œâ”€â”€ test_formats.py
â”‚   â”œâ”€â”€ test_workflow.py
â”‚   â””â”€â”€ test_constraints.py
â”œâ”€â”€ parsers/
â”‚   â”œâ”€â”€ test_opus_parser.py
â”‚   â”œâ”€â”€ test_module_parser.py
â”‚   â”œâ”€â”€ test_function_parser.py
â”‚   â””â”€â”€ test_variable_parser.py
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ test_string_utils.py
â”‚   â”œâ”€â”€ test_validation.py
â”‚   â”œâ”€â”€ test_converters.py
â”‚   â””â”€â”€ test_error_handlers.py
â””â”€â”€ conftest.py
```

## ğŸ“ æµ‹è¯•ç¼–å†™è§„èŒƒ

### æµ‹è¯•ç±»ç»„ç»‡
```python
class TestIdentityModule:
    """Identityæ¨¡å—æµ‹è¯•ç±»"""
    
    def setup_method(self):
        """æ¯ä¸ªæµ‹è¯•æ–¹æ³•æ‰§è¡Œå‰çš„å‡†å¤‡"""
        self.identity = Identity()
    
    def teardown_method(self):
        """æ¯ä¸ªæµ‹è¯•æ–¹æ³•æ‰§è¡Œåçš„æ¸…ç†"""
        pass
    
    def test_create_identity_with_valid_data(self):
        """æµ‹è¯•ä½¿ç”¨æœ‰æ•ˆæ•°æ®åˆ›å»ºèº«ä»½"""
        # Given
        identity_data = {
            "name": "æµ‹è¯•åŠ©æ‰‹",
            "role": "AIåŠ©æ‰‹",
            "expertise": ["Python", "æµ‹è¯•"]
        }
        
        # When
        result = self.identity.create(identity_data)
        
        # Then
        assert result.is_valid()
        assert result.name == "æµ‹è¯•åŠ©æ‰‹"
        assert "Python" in result.expertise
```

### æµ‹è¯•æ–¹æ³•å‘½å
```python
def test_[è¢«æµ‹è¯•çš„æ–¹æ³•]_[æµ‹è¯•åœºæ™¯]_[æœŸæœ›ç»“æœ]():
    """
    å‘½åè§„èŒƒï¼š
    - test_create_identity_with_valid_data_should_return_identity
    - test_parse_opus_syntax_with_invalid_format_should_raise_error
    - test_generate_memory_map_when_empty_input_should_return_default
    """
    pass
```

## ğŸ­ æµ‹è¯•æ¨¡å¼å’ŒæŠ€å·§

### AAAæ¨¡å¼ (Arrange-Act-Assert)
```python
def test_workflow_execution_with_valid_steps():
    # Arrange - å‡†å¤‡æµ‹è¯•æ•°æ®å’Œç¯å¢ƒ
    workflow = Workflow()
    steps = [
        {"action": "analyze", "input": "éœ€æ±‚æè¿°"},
        {"action": "generate", "output": "æ™ºèƒ½ä½“"}
    ]
    
    # Act - æ‰§è¡Œè¢«æµ‹è¯•çš„æ“ä½œ
    result = workflow.execute(steps)
    
    # Assert - éªŒè¯ç»“æœ
    assert result.is_successful()
    assert len(result.outputs) == 2
```

### å‚æ•°åŒ–æµ‹è¯•
```python
import pytest

@pytest.mark.parametrize("input_data,expected", [
    ("ç®€å•éœ€æ±‚", "basic_agent"),
    ("å¤æ‚AIåŠ©æ‰‹éœ€æ±‚", "advanced_agent"),
    ("ä¸“ä¸šä»£ç å®¡æŸ¥", "code_reviewer"),
])
def test_generate_agent_type_detection(input_data, expected):
    """æµ‹è¯•æ™ºèƒ½ä½“ç±»å‹æ£€æµ‹"""
    generator = AgentGenerator()
    result = generator.detect_type(input_data)
    assert result == expected
```

### Mockå’ŒStubä½¿ç”¨
```python
from unittest.mock import Mock, patch

def test_external_api_integration():
    """æµ‹è¯•å¤–éƒ¨APIé›†æˆ"""
    # Mockå¤–éƒ¨ä¾èµ–
    with patch('opus.external.openai_client') as mock_client:
        mock_client.generate.return_value = "ç”Ÿæˆçš„å†…å®¹"
        
        # æ‰§è¡Œæµ‹è¯•
        generator = Generator()
        result = generator.generate_with_ai("æµ‹è¯•è¾“å…¥")
        
        # éªŒè¯è°ƒç”¨
        mock_client.generate.assert_called_once_with("æµ‹è¯•è¾“å…¥")
        assert result == "ç”Ÿæˆçš„å†…å®¹"
```

## ğŸ§ª å…·ä½“æµ‹è¯•ç¤ºä¾‹

### Identityæ¨¡å—æµ‹è¯•
```python
class TestIdentityModule:
    """Identityæ¨¡å—å®Œæ•´æµ‹è¯•ç¤ºä¾‹"""
    
    @pytest.fixture
    def valid_identity_data(self):
        return {
            "name": "ä»£ç å®¡æŸ¥åŠ©æ‰‹",
            "role": "é«˜çº§å¼€å‘è€…",
            "personality": "ä¸¥è°¨ã€ä¸“ä¸š",
            "expertise": ["Python", "ä»£ç è´¨é‡", "æœ€ä½³å®è·µ"],
            "communication_style": "ç›´æ¥ã€å»ºè®¾æ€§"
        }
    
    def test_create_identity_success(self, valid_identity_data):
        """æµ‹è¯•æˆåŠŸåˆ›å»ºèº«ä»½"""
        identity = Identity.create(valid_identity_data)
        
        assert identity.name == "ä»£ç å®¡æŸ¥åŠ©æ‰‹"
        assert identity.role == "é«˜çº§å¼€å‘è€…"
        assert len(identity.expertise) == 3
    
    def test_create_identity_missing_required_field(self):
        """æµ‹è¯•ç¼ºå°‘å¿…éœ€å­—æ®µæ—¶çš„å¤„ç†"""
        incomplete_data = {"role": "åŠ©æ‰‹"}
        
        with pytest.raises(ValidationError) as exc_info:
            Identity.create(incomplete_data)
        
        assert "name is required" in str(exc_info.value)
    
    def test_validate_expertise_format(self):
        """æµ‹è¯•ä¸“ä¸šæŠ€èƒ½æ ¼å¼éªŒè¯"""
        invalid_data = {
            "name": "åŠ©æ‰‹",
            "role": "å¼€å‘è€…",
            "expertise": "Python"  # åº”è¯¥æ˜¯åˆ—è¡¨
        }
        
        with pytest.raises(ValidationError):
            Identity.create(invalid_data)
```

### è¯­æ³•è§£æå™¨æµ‹è¯•
```python
class TestOpusParser:
    """OPUSè¯­æ³•è§£æå™¨æµ‹è¯•"""
    
    def test_parse_valid_identity_block(self):
        """æµ‹è¯•è§£ææœ‰æ•ˆçš„Identityå—"""
        opus_text = """
        # Identity
        name: æµ‹è¯•åŠ©æ‰‹
        role: AIåŠ©æ‰‹
        expertise: [Python, æµ‹è¯•, è‡ªåŠ¨åŒ–]
        """
        
        parser = OpusParser()
        result = parser.parse(opus_text)
        
        assert result.identity.name == "æµ‹è¯•åŠ©æ‰‹"
        assert "Python" in result.identity.expertise
    
    def test_parse_invalid_syntax(self):
        """æµ‹è¯•è§£ææ— æ•ˆè¯­æ³•"""
        invalid_opus = """
        # Identity
        name: 
        role: [æ— æ•ˆæ ¼å¼
        """
        
        parser = OpusParser()
        
        with pytest.raises(SyntaxError) as exc_info:
            parser.parse(invalid_opus)
        
        assert "Invalid syntax at line 3" in str(exc_info.value)
    
    @pytest.mark.parametrize("block_type,content,expected_type", [
        ("Identity", "name: åŠ©æ‰‹", IdentityBlock),
        ("Memory", "type: session", MemoryBlock),
        ("Workflow", "steps: [step1]", WorkflowBlock),
    ])
    def test_parse_different_block_types(self, block_type, content, expected_type):
        """æµ‹è¯•è§£æä¸åŒç±»å‹çš„å—"""
        opus_text = f"# {block_type}\n{content}"
        
        parser = OpusParser()
        result = parser.parse(opus_text)
        
        assert isinstance(getattr(result, block_type.lower()), expected_type)
```

## ğŸ¯ æµ‹è¯•æ•°æ®ç®¡ç†

### æµ‹è¯•å¤¹å…· (Fixtures)
```python
# conftest.py
import pytest
from opus.core import Agent, Identity, Memory

@pytest.fixture
def sample_agent():
    """åˆ›å»ºç¤ºä¾‹æ™ºèƒ½ä½“"""
    identity = Identity(name="æµ‹è¯•åŠ©æ‰‹", role="AIåŠ©æ‰‹")
    memory = Memory(type="session")
    return Agent(identity=identity, memory=memory)

@pytest.fixture
def opus_samples():
    """OPUSè¯­æ³•ç¤ºä¾‹"""
    return {
        "simple": """
        # Identity
        name: ç®€å•åŠ©æ‰‹
        role: åŸºç¡€åŠ©æ‰‹
        """,
        "complex": """
        # Identity
        name: å¤æ‚åŠ©æ‰‹
        role: é«˜çº§åŠ©æ‰‹
        expertise: [AI, ML, NLP]
        
        # Memory
        type: persistent
        retention: 30d
        
        # Workflow
        steps:
          - analyze_input
          - generate_response
          - validate_output
        """
    }
```

### å·¥å‚æ¨¡å¼
```python
import factory
from opus.core import Identity, Agent

class IdentityFactory(factory.Factory):
    class Meta:
        model = Identity
    
    name = factory.Faker('name')
    role = factory.Faker('job')
    expertise = factory.LazyFunction(lambda: ["AI", "Python"])

class AgentFactory(factory.Factory):
    class Meta:
        model = Agent
    
    identity = factory.SubFactory(IdentityFactory)
    memory = factory.LazyFunction(lambda: Memory(type="session"))

# ä½¿ç”¨
def test_agent_creation():
    agent = AgentFactory()
    assert agent.identity.name is not None
```

## ğŸš¦ æµ‹è¯•æ‰§è¡Œå’ŒæŠ¥å‘Š

### æœ¬åœ°æµ‹è¯•æ‰§è¡Œ
```bash
# æ‰§è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
pytest tests/unit/

# æ‰§è¡Œç‰¹å®šæ¨¡å—æµ‹è¯•
pytest tests/unit/core/test_identity.py

# æ‰§è¡Œç‰¹å®šæµ‹è¯•æ–¹æ³•
pytest tests/unit/core/test_identity.py::TestIdentityModule::test_create_identity_success

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest tests/unit/ --cov=opus --cov-report=html
```

### æµ‹è¯•æŠ¥å‘Šåˆ†æ
```bash
# æŸ¥çœ‹è¯¦ç»†è¦†ç›–ç‡æŠ¥å‘Š
open htmlcov/index.html

# å‘½ä»¤è¡Œè¦†ç›–ç‡æ‘˜è¦
pytest --cov=opus --cov-report=term-missing
```

## ğŸ“Š è´¨é‡æŒ‡æ ‡

### è¦†ç›–ç‡ç›®æ ‡
- **è¯­å¥è¦†ç›–ç‡**: â‰¥ 90%
- **åˆ†æ”¯è¦†ç›–ç‡**: â‰¥ 85%
- **å‡½æ•°è¦†ç›–ç‡**: â‰¥ 95%

### æµ‹è¯•è´¨é‡æŒ‡æ ‡
- **æµ‹è¯•é€šè¿‡ç‡**: 100%
- **æµ‹è¯•æ‰§è¡Œæ—¶é—´**: < 60ç§’
- **æµ‹è¯•ç»´æŠ¤æˆæœ¬**: ä½

## ğŸ“ æœ€ä½³å®è·µ

### Do's âœ…
- **å•ä¸€èŒè´£** - æ¯ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä¸ªè¡Œä¸º
- **ç‹¬ç«‹æ€§** - æµ‹è¯•é—´æ— ä¾èµ–å…³ç³»
- **å¯è¯»æ€§** - æ¸…æ™°çš„æµ‹è¯•åç§°å’Œç»“æ„
- **å¿«é€Ÿæ‰§è¡Œ** - é¿å…è€—æ—¶æ“ä½œ
- **è¾¹ç•Œæµ‹è¯•** - æµ‹è¯•è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µ

### Don'ts âŒ
- **æµ‹è¯•ç§æœ‰æ–¹æ³•** - ä¸“æ³¨äºå…¬å…±æ¥å£
- **è¿‡åº¦Mock** - é¿å…è¿‡åº¦æ¨¡æ‹Ÿå¯¼è‡´æµ‹è¯•æ— æ„ä¹‰
- **ç¡¬ç¼–ç ** - ä½¿ç”¨å‚æ•°åŒ–å’Œå·¥å‚æ¨¡å¼
- **å¿½ç•¥æ¸…ç†** - ç¡®ä¿æµ‹è¯•åçŠ¶æ€æ¸…ç†

## ğŸ”§ è°ƒè¯•å’Œé—®é¢˜æ’æŸ¥

### å¸¸è§é—®é¢˜
1. **å¯¼å…¥é”™è¯¯** - æ£€æŸ¥Pythonè·¯å¾„é…ç½®
2. **å¼‚æ­¥æµ‹è¯•å¤±è´¥** - ä½¿ç”¨pytest-asyncio
3. **Mockä¸ç”Ÿæ•ˆ** - æ£€æŸ¥patchè·¯å¾„
4. **è¦†ç›–ç‡ä¸å‡†ç¡®** - ç¡®è®¤æµ‹è¯•è·¯å¾„é…ç½®

### è°ƒè¯•æŠ€å·§
```python
# ä½¿ç”¨pdbè°ƒè¯•
def test_debug_example():
    import pdb; pdb.set_trace()
    result = function_under_test()
    assert result == expected

# ä½¿ç”¨pytestå‚æ•°
pytest -s -v tests/unit/  # æ˜¾ç¤ºprintè¾“å‡º
pytest --pdb tests/unit/  # å¤±è´¥æ—¶è¿›å…¥è°ƒè¯•å™¨
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æµ‹è¯•æ¦‚è¿°](01-æµ‹è¯•æ¦‚è¿°.md) - æ•´ä½“æµ‹è¯•ç­–ç•¥
- [é›†æˆæµ‹è¯•æŒ‡å—](03-é›†æˆæµ‹è¯•.md) - é›†æˆæµ‹è¯•æ–¹æ³•
- [æµ‹è¯•æ•°æ®ç®¡ç†](05-æµ‹è¯•æ•°æ®ç®¡ç†.md) - æµ‹è¯•æ•°æ®è§„èŒƒ
- [è‡ªåŠ¨åŒ–æµ‹è¯•](06-è‡ªåŠ¨åŒ–æµ‹è¯•.md) - CI/CDé›†æˆ

---

*ğŸ¯ å•å…ƒæµ‹è¯•æ˜¯ä»£ç è´¨é‡çš„åŸºçŸ³ï¼Œè¯·ä¸¥æ ¼éµå¾ªæµ‹è¯•é©±åŠ¨å¼€å‘çš„æœ€ä½³å®è·µã€‚*